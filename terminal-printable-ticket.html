<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="imports.html">
<link rel="import" href="ticket-print-styles.html">
<link rel="import" href="ticket-template-loader.html">

<link rel="import" href="ticket-template-register.html">
<link rel="import" href="transforms/ticket-time-transform.html">
<link rel="import" href="transforms/ticket-code-transform.html">
<link rel="import" href="transforms/ticket-optional.html">
<link rel="import" href="transforms/ticket-processing-time-transform.html">
<link rel="import" href="transforms/ticket-operational-workstations-transform.html">
<link rel="import" href="transforms/ticket-fields-list.html">

<dom-module id="terminal-printable-ticket">
  <template>
    <style>
      :host {
        display: block;
        color: black;
        z-index: 1000;
        position: relative;
      }
      .ticket-print-view {
        display: none;
      }
      @media print {
        .ticket-print-view {
          display: block;
        }
      }

    </style>
    <iris-shared-entities id="services" namespace="services"></iris-shared-entities>
    <iris-shared-entities id="office" namespace="office"></iris-shared-entities>
    <iris-shared-entities id="hierarchy" namespace="hierarchy"></iris-shared-entities>
    <iris-shared-entities id="departments" namespace="departments"></iris-shared-entities>
    <!-- <ticket-template-loader name="test"></ticket-template-loader> -->

    <div class="ticket-print-view">
      <div style="display:none; float: right; margin-left: auto; margin-right: auto; width: 30%;">
        <img id="logo" border="0" alt="" src="../../images/logo-bw-short.png" style="height: 40px; float: right; padding-bottom: 5px;"/>
      </div>

      <div id="stamp"></div>
    </div>

  </template>

  <script>
    (function () {
      'use strict'
      let _meta = Polymer.Base.create('iron-meta', {type: 'iris-ticket-stamps'});

      let getTemplate = function (name) {
        let model = _meta.byKey(name);
        let template = model.getTemplate();
        return template;
      };

      Polymer({
        is: 'terminal-printable-ticket',
        properties: {
          templateName: {
            type: String,
            value: 'live'
          }
        },
        behaviors: [Polymer.Templatizer],
        init(ticket, context) {
          this.style.display = 'block';
          ticket = ticket || {};

          console.log('templateName', this.templateName);
          this.templatize(getTemplate(this.templateName));
          this.clone = this.stamp({
            ticket: ticket,
            service: this.$.services.get(ticket.service),
            department: this.$.office.get(),
            office: this.getOffice(ticket),
            context: context
          });

          Polymer.dom(this.$.stamp).innerHTML = "";
          let result = Polymer.dom(this.$.stamp).appendChild(this.clone.root);

          this.$.stamp.querySelector('#logoTarget').src = this.$.logo.src;
        },
        print() {
          window.print();
          this.style.display = 'none';
        },
        getOffice(ticket) {
          let hierarchy = _.values(this.$.hierarchy.get()) || [];
          let org = ticket.org_destination;
          return this.$.departments.get(org) || hierarchy[hierarchy.length - 1];
        }

      });
    })();
  </script>
</dom-module>
